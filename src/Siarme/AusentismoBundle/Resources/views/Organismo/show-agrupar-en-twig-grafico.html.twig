{% extends 'ExpedienteBundle:Default:layout.html.twig' %}
{% block title %} {{organismo.codigoGde}}{% endblock %}
{% block contenido %}
 <div class="container"> 
 <ul class="nav nav-pills hidden-print"> 
      <li><a  data-toggle="tooltip" data-placement="bottom" title="Modificar los datos del organismo" href="{{ path('organismo_edit', { 'id': organismo.id }) }}"><span class="glyphicon glyphicon-pencil">Modificar</span></a>
      </li> 
      
       <!-- Menu DERECHO *** IMPRIMIR - COPIAR -->
    <div class="pull-right">
            <li  role="presentation">
              
              <a id="printer"  value="Imprimir" role="button"><!-- Printer-imprime el texto de clase="print" -->
                <span class="glyphicon glyphicon-print"></span> Imprimir</a>

                <a class="btn" data-clipboard-target="#copy"><!-- clipboard-copiar texto de id="copy" -->
                  <span class="glyphicon glyphicon-copy"></span>Copiar</a>
            </li>
    </div> 
</ul> 
<div id="copy" class="panel panel-default print"> 
        <style type="text/css" media="print">
        @media print {
            a[href]:after {
                content: none !important;
            }
        }
      </style> 
        <div class="panel-heading"> 
                SAF N°  {{ organismo.saf.numeroSaf }} - {{ organismo.organismo }} -  {{ organismo.codigoGde}}
        </div>
<div class="panel-body"> 
                  <ul class="list-inline">
                    <li>CUIT: {{ organismo.saf.cuil }}</li>
                    <li> 
                      <span class='glyphicon glyphicon-phone'>Telefono:</span> <strong> {{ organismo.saf.telefonoMovil }} {% if organismo.saf.telefonoMovil | length > 9 %} 
                                  <a data-tel='{{ organismo.saf.telefonoMovil}}' data-msj='Mensaje de {{ app.user}} de la SCA: ' style="font-size:16px;" class="btn-enviar-mensaje bg-success img-circle"><span data-toggle="tooltip" data-placement="top" title='Enviar Mensaje Whatsapp' class="glyphicon glyphicon-earphone text-success" ></span>Msj</a>
                         {% endif %}
                       </strong>
                    </li>
                    <li>
                       Email: <strong>{{ organismo.saf.email }}</strong>   
                        {% if organismo.saf.email | length > 5 %}             
                                      <span role="presentation" class="dropdown" >
                                                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"> <span class="glyphicon glyphicon-send"></span> Email<span class="caret"></span>
                                          </a>
                                          <ul class="dropdown-menu text-left dropdown-menu-right">
                                            <li>
                                                <form class="navbar-form"  method="post" action="{{ path('email_enviar') }}">
                                                    <div class="input-group">
                                                      <label for="to">Email:</label>
                                                     <input type="email" class="form-control" name="to" value='{{ organismo.saf.email }}' readonly>
                                                     </div> <br><br>
                                                    <div class="input-group">
                                                    <label for="subjet">Asunto:</label> <br>  
                                                     <input type="text" class="form-control" name="subjet" value='Mensaje de {{ app.user}} de la SCA' style="width:320px" readonly>
                                                     </div><br>
                                                     <div class="form-group">
                                                      <label for="texto">Texto:</label>
                                                     <textarea class="form-control" name="texto" rows="7" cols="50"> {{ organismo }},  </textarea>
                                                     </div>
                                                     <br>
                                                     <button type="submit" class="button btn-sm btn-primary pull-right">Enviar</button>
                                                </form> 
                                            </li>
                                          </ul>
                                </span>
                            {% endif %} 
                    </li>                    
                  </ul>
 </div>
 <div class="panel-group" id="accordion">
{% if (organismo.cargo | length) > 0  %} 
 <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title text-info">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href='#collapseTwo'>
          <span class="glyphicon glyphicon-plus  text-info" ></span>  <span class="glyphicon glyphicon-user"></span> EMPLEADOS ({{ organismo.cargo | length }})
        </a>
      </h4>
    </div>
    <div id="collapseTwo" class="panel-collapse collapse">
      <div  class="panel-body ">                    
             <table id="tablaAgente" class="table table-condensed text-left">
                <tbody> 
               {% for cargo in organismo.cargo %}
               {% set agente = cargo.agente %}
                    {{ include('AusentismoBundle:Agente:_tbody_completo.html.twig') }} 
               {% endfor %}
                </tbody>
            </table>     
      </div>
    </div>
  </div>
{% endif %}
 {% set t1, t2, t3, t4, p1, p2, p3, p4, arraysRubros, arrayRubro, rubro = 0, 0, 0, 0, 0, 0, 0, 0, [], {'rubro': "", 'cantidad': 0, 'presupuesto': 0}, {'id':0} %}
  {% if (tipoTramites | length) != 0  %}
  {% for tipoTramite in tipoTramites | reverse %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title text-info">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href='#{{tipoTramite}}'>
          <span {% if loop.first %}class="glyphicon glyphicon-minus"{% else %}class="glyphicon glyphicon-plus  text-info" {% endif %} ></span>  <span class="{{tipoTramite.glyphicon}}"></span> {{tipoTramite}} ({{organismo.tramite | length}})
        </a>
      </h4>
    </div>
    <div id="{{tipoTramite}}" class="panel-collapse collapse {% if loop.first %}in{% endif %}">
      <div  class="panel-body ">       
                       
              {% for tramite in tipoTramite.tramite | sort((a, b) => a.rubro <=> b.rubro)  %}   

                          {# para la estadistica 1° grafico #}
                       {% if tramite.trimestre == 1 %} {% set t1, p1 = t1 + tramite.itemPedido | length, p1 + tramite.presupuestoOficial  %} {% endif %}  
                       {% if tramite.trimestre == 2 %} {% set t2, p2 = t2 + tramite.itemPedido | length, p2 + tramite.presupuestoOficial  %} {% endif %}  
                       {% if tramite.trimestre == 3 %} {% set t3, p3 = t3 + tramite.itemPedido | length, p3 + tramite.presupuestoOficial  %} {% endif %}  
                       {% if tramite.trimestre == 4 %} {% set t4, p4 = t4 + tramite.itemPedido | length, p4 + tramite.presupuestoOficial  %} {% endif %}  
 

                       {# para la estadistica 2° grafico #}
                        {% if rubro.id == tramite.rubro.id  %}
                            {% set  arrayRubro = {'rubro': tramite.rubro, 'cantidad': arrayRubro.cantidad + tramite.itemPedido | length, 'presupuesto': arrayRubro.presupuesto + tramite.presupuestoOficial } %}
                        {% else %} 
                            {% set  rubro, arrayRubro, arraysRubros = tramite.rubro, {'rubro': tramite.rubro, 'cantidad': tramite.itemPedido | length, 'presupuesto': tramite.presupuestoOficial },  arraysRubros | merge([arrayRubro]) %} 
                        {% endif %}        

                        {# cabecera de tabla #}
                         {% if loop.first %}

                              <table class="table table-hover">
                                  <thead>
                                    {{ include('ExpedienteBundle:'~ tramite.tipoTramite.slug ~':_thead_completo.html.twig') }}         
                                  </thead>
                                  <tbody>
                            {% endif %}   

                                      {# filtro los tramites que no tienen expedientes #}

                                     {{ include('ExpedienteBundle:'~ tramite.tipoTramite.slug ~':_tbody_completo.html.twig') }}    
              {% endfor %}
              {% set  arraysRubros =  arraysRubros | merge([arrayRubro]) %}
                                  </tbody>
                              </table>          
      </div>
    </div>
  </div>
{% endfor %}
{% endif %}


  {% set cantidad, itemsPedidos = 0, {} %} 
  {% for tramite in organismo.tramite if tramite.fecha | date('Y') ==  'now' | date ('Y') %}  
         {% set cantidad = cantidad + tramite.itemPedido | length %}  
         {% set itemsPedidos = itemsPedidos | merge(tramite.itemPedido) %}           
 {% endfor %}

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#collapseCero">
          <span class="glyphicon glyphicon-plus  text-info"></span> <span class="fa fa-bars"></span> ÍTEMS / AÑO {{'now' | date ('Y')}} ({{cantidad}})
        </a>
      </h4>
    </div>
    <div id="collapseCero" class="panel-collapse collapse">
      <div  class="panel-body ">
            <table id="tablaItemPedido" class="table table-hover text-left">
              <thead>
                {{ include('AusentismoBundle:ItemPedido:_thead_simple.html.twig') }}
              </thead>
              <tbody>

                 {% for itemPedido in itemsPedidos %}
                     {{ include('AusentismoBundle:ItemPedido:_tbody_simple.html.twig') }}
                 {% endfor %}
              </tbody>
            </table> 
      </div>
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion" href="#reporte">
          <span class="glyphicon glyphicon-plus  text-info"></span> <span class="glyphicon glyphicon-stats"></span> REPORTE - AÑO / {{'now' | date ('Y')}}
        </a>
      </h4>
    </div>
    <div id="reporte" class="panel-collapse collapse">
      <div  class="panel-body ">
          <div class="list-group-item">
            <table class="table table-striped">
              <thead class="text-center">
                <tr> <h3> CANTIDAD DE ITEMS POR TRIMESTRE </h3> </tr>
               <tr>
                  <th>Trimestres</th> <th>Cantidad</th><th>Presupuesto</th> <th>Total</th>
               </tr>
             </thead>
              <tbody>
                  <tr> 
                    <th>1° Trimestre</th>
                    <td>{{t1}}</td>
                    <td>$ {{p1 | number_format(2, ',', '.')}}</td>
                    <td>$ {{(t1 * p1) | number_format(2, ',', '.') }}</td>
                  </tr> 
                   <tr> 
                    <th>2° Trimestre</th>
                    <td>{{t2}}</td>
                    <td>$ {{p2 | number_format(2, ',', '.') }}</td>
                    <td>$ {{(t2 * p2) | number_format(2, ',', '.')}}</td>
                  </tr>
                  <tr> 
                    <th>3° Trimestre</th>
                    <td>{{t3}}</td>
                    <td>$ {{p3 | number_format(2, ',', '.')}}</td>
                    <td>$ {{(t3 * p3) | number_format(2, ',', '.')}}</td>
                  </tr>
                  <tr> 
                    <th>4° Trimestre</th>
                    <td>{{t4}}</td>
                    <td>$ {{p4 | number_format(2, ',', '.') }}</td>
                    <td>$ {{(t4 * p4) | number_format(2, ',', '.')}}</td>
                  </tr>
              </tbody>
            </table>
            <div id="chartTrimestre" style="height: 300px; max-width: 100%"></div>
          </div>
          <div class="clearfix"></div>
          <div class="list-group-item">
            <table class="table table-striped">
              <thead class="text-center">
                <tr><h3>CANTIDAD DE ITEMS POR RUBO</h3> </tr>
               <tr>
                  <th>Rubro</th><th>Cantidad</th><th>Presupuesto</th><th>Total</th>
               </tr>
             </thead>
              <tbody>
                {% for rubro in arraysRubros %}
                  {% if not loop.first %}
                  <tr>
                    <td>{{rubro.rubro}}</td>
                    <td>{{rubro.cantidad}}</td>
                    <td>$ {{rubro.presupuesto | number_format(2, ',', '.')}}</td>
                    <td>$ {{ ( rubro.cantidad * rubro.presupuesto ) | number_format(2, ',', '.') }}</td>
                  </tr> 
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
              <div id="chartRubro"  style="height: 500px; max-width: 100%;"></div>
          </div>

      </div>
    </div>
  </div>

{#
   <!-- /.col-md-6 -->
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header no-border">
                <div class="d-flex justify-content-between">
                  <h3 class="card-title">CANTIDAD DE ITEMS POR RUBRO Y TRIMESTRE</h3>
                  <a href="javascript:void(0);">Ver Reporte</a>
                </div>
              </div>
              <div class="card-body">
                <div class="d-flex">
                  <p class="d-flex flex-column">
                    <span class="text-bold text-lg">523</span>
                    <span>Item año 2021</span>
                  </p>
                </div>
                <!-- /.d-flex -->

                <div class="position-relative mb-4">
                  <canvas id="sales-chart" height="200"></canvas>
                </div>

                <div class="d-flex flex-row justify-content-end">
                  <span class="mr-2">
                    <i class="fa fa-square text-primary"></i> This year
                  </span>

                  <span>
                    <i class="fa fa-square text-gray"></i> Last year
                  </span>
                </div>
              </div>
            </div>
       </div> #}

</div> <!-- Panel Accordion-->
<div class="clearfix"></div>

</div>
</div>
 {% set arrayTrimestre = { t1: t1, t2: t2, t3: t3, t4: t4} %}

{{ app.session.set('arrayTrimestre', arrayTrimestre) }}
{{ app.session.set('arraysRubros', arraysRubros) }}

{{ app.session.set('t1', t1) }}
{{ app.session.set('t2', t2) }}
{{ app.session.set('t3', t3) }}
{{ app.session.set('t4', t4) }}
{% endblock %}
 {% block footer %}
<dir class="footer"></dir>
{% endblock %} 

{% block javascripts %}  
{{ parent() }}
    <script src="{{ asset('bundles/expediente/plugins/chart.js/Chart.min.js') }}">
    </script>    
    <script src="{{ asset('bundles/expediente/plugins/pages/dashboard3.js') }}">
    </script> 
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"> </script>
<script type="text/javascript">
$(function () {
///GRAFICO CANTIDAD DE ITEMS POR TRIMESTRE
var chart = new CanvasJS.Chart("chartTrimestre", {
  theme: "light2", // "light2", "dark1", "dark2"
  animationEnabled: false, // change to true    
  title:{
    text: ""
  },
  data: [
  {
    // Change type to "bar", "area", "spline", "pie",etc.
    type: "column",
    dataPoints: [
      { label: "1° Trimestre",  y: {{ app.session.get('arrayTrimestre').t1 }}  },
      { label: "2° Trimestre", y: {{ app.session.get('arrayTrimestre').t2  }}  },
      { label: "3° Trimestre", y: {{ app.session.get('arrayTrimestre').t3 }}  },
      { label: "4° Trimestre",  y: {{ app.session.get('arrayTrimestre').t4 }} },
      // inicializo trimestre a 0
      {{ app.session.set('arrayTrimestre', 0) }}
    ]
  }
  ]
});
chart.render();

///GRAFICO RUBRO POR TOTAL POR RUBRO Y AÑO
var chart = new CanvasJS.Chart("chartRubro", {
  animationEnabled: true,
  
  title:{
    text:""
  },
  axisX:{
    interval: 1
  },
  axisY2:{
    interlacedColor: "rgba(1,77,101,.2)",
    gridColor: "rgba(1,77,101,.1)",
    title: ""
  },
  data: [{
    type: "bar",
    name: "Rubros",
    axisYType: "secondary",
    color: "#014D65",
    dataPoints: [
        {% set arraysRubros = app.session.get('arraysRubros') %}
        {% for rubro in arraysRubros %}
            {% if not loop.first %}
                { y: {{rubro.cantidad}}, label: '{{rubro.rubro}}' },
           {% endif %}
        {% endfor %}
    ]
  }]
});
chart.render();
});
</script>
{% endblock %}